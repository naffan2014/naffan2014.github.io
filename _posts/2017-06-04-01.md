---
title: 正确理解javascript中的Event loop机制
category: tech
tag: javascript
picUrl: null 
cover: https://ooo.0o0.ooo/2017/06/07/5937d6a8a933b.png
---

这两个星期一直在想着写一篇关于javascript中event Loop的文章。自从写完上一篇[《Javascript捕捉(capturing)与冒泡(bubbling)的区别》](http://naffan.cn/tech/2016/12/10/1.html)之后，我抛出了一个问题。当时的我对event loop的概念还很模糊，只是觉得这个问题隐隐约约跟它有关系。我当然不能放下这个问题太久，太久了就会忘记自己原先的初衷了。所以，在看了很多关于event loop的文章和视频以后我打算将这篇文章写出来。在文章的最后，我将列举出我所翻阅的所有资料，而且我很建议大家看一看。

想要了解event loop的概念，首先就要知道几个有关的概念。

* 什么叫做栈

栈（stack），是计算机内存存储的一种方式。数据进入栈叫做压栈，数据从栈中出来叫做出栈。栈的存储方式只支持先进后出，后进先出的原则。如果你熟悉C语言的话，你就会知道栈中的数据是静态数据，这些数据是由计算机分配的数据，不能被我们程序员进行更改。

* 什么叫做堆

堆（heap），也是计算机内存存储的一种方式。数据根据所属的某种key分散存储在内存单元。同样你如果熟悉C语言的话，你就会知道堆中的数据是动态数据，是由操作者们单独创建出来的存储单元。

* 什么叫做队列

队列（queue），他是一种解决问题的方法。我们人为的规定队列中的数据具有先进先出，后进后出的规则。也就是说如果你想出队你就必须等你前面的所有数据全部出队以后你才可以出队。

我相信有了以上的几种知识，你就能够明白我接下来要解释的长篇大论了。我们知道多个事情并发的时候就会出现你忙不过来的情况，如果你忙不过来那么就得让所有后面的事情等待你先解决手头的事情。这样就会出现后面的事务堆积得不到解决，那么我们怎么解决这个问题呢？javascript采用的并发模型是基于“事件循环”的。那什么叫做事件循环呢？下面我就一点一点展开。

首先声明的是，javascript是单线程的。他不可能有多线程的性质，而只是在模仿多线程的样子让我们感觉像多线程一样。

<script async src="//jsfiddle.net/naffan/yas8jLho/embed/js,html,css,result/dark/"></script>

![](media/14968467368509.jpg)

从上图，我们可以看到这段代码展示的形式就是栈的表示方法。最先运行的代码最先压进栈，我们可以看到onload其实就是代码的main函数，然后依次压栈bazz,bar,foo，而在foo中抛出一个错误停止了程序的运行。

在javascript中我们运行代码的时候，如果执行的时间很长，那么我们在这段时间内是做不了别的事情的。这就是单线程的弊端。我们可以运行个例子进行测试。

<script async src="//jsfiddle.net/naffan/qg247n3b/embed/js,html,css,result/dark/"></script>

![](media/14968497803393.jpg)

上面的程序，我们进行了递归调用，并且没有做异常处理。那么运行的时候会无限的调用foo函数直到碰触到内存中的栈最大值，这个时候js会抛出系统异常并终止程序。

在这里我有个好奇点，栈到底有多大呢？当然，我不能具体量化到栈可以存储多少个字节，但是我可以通过循环的次数大体判断一下。

<script async src="//jsfiddle.net/naffan/m2aherx0/embed/js,html,css,result/dark/"></script>

这段代码在不同的浏览器中会有不同的结果，大体结果如下：

### Internet Explorer

* IE6: 1130
* IE7: 2553
* IE8: 1475
* IE9: 20678
* IE10: 20677
*  IE11:54375
*  edge : 16615

### Mozilla Firefox

* 3.6: 3000
* 4.0: 9015
* 5.0: 9015
* 6.0: 9015
* 7.0: 65533
* 8b3: 63485
* 17: 50762
* 18: 52596
* 19: 52458
* 42: 281810
* 49: 8921 


### Google Chrome

* 14: 26177
* 15: 26168
* 16: 26166
* 25: 25090
* 28: 26000
* 47: 20878
* 51: 41753
* 56: 20922 

### Safari

* 4: 52426
* 5: 65534
* 9: 63444
* 10: 73399

### Opera

* 10.10: 9999
* 10.62: 32631
* 11: 32631
 * 12: 32631



* https://www.youtube.com/watch?v=8aGhZQkoFbQ
* https://2014.jsconf.eu/speakers/philip-roberts-what-the-heck-is-the-event-loop-anyway.html
* [相当推荐的工具，由于连接较长影响了美观，所以做成了超链接](http://latentflip.com/loupe/?code=JC5vbignYnV0dG9uJywgJ2NsaWNrJywgZnVuY3Rpb24gb25DbGljaygpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gdGltZXIoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ1lvdSBjbGlja2VkIHRoZSBidXR0b24hJyk7ICAgIAogICAgfSwgMjAwMCk7Cn0pOwoKY29uc29sZS5sb2coIkhpISIpOwoKc2V0VGltZW91dChmdW5jdGlvbiB0aW1lb3V0KCkgewogICAgY29uc29sZS5sb2coIkNsaWNrIHRoZSBidXR0b24hIik7Cn0sIDUwMDApOwoKY29uc29sZS5sb2coIldlbGNvbWUgdG8gbG91cGUuIik7!!!PGJ1dHRvbj5DbGljayBtZSE8L2J1dHRvbj4%3D)
* https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop
* https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RangeError


